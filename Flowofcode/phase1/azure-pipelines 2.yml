trigger:
- main

pool:
  name: local-agent-pool

variables:
  APP_NAME: "sample-app"
  ENVIRONMENT: "dev"
  BUILD_OUTPUT: "$(Build.ArtifactStagingDirectory)/output"
  PIPELINE_TYPE: "SelfHosted-Enterprise"

stages:

# ==============================
# STAGE 1: AGENT & ENV VALIDATION
# ==============================
- stage: AgentValidation
  displayName: "Stage 1 - Agent & Environment Validation"
  jobs:
  - job: ValidateAgent
    steps:
    - checkout: self

    - script: |
        set -e

        echo "=============================="
        echo "üöÄ PIPELINE TYPE : $(PIPELINE_TYPE)"
        echo "üåç ENVIRONMENT   : $(ENVIRONMENT)"
        echo "=============================="

        echo "üîπ Host Info"
        hostname
        uname -a

        echo "üîπ Date & Time"
        date

        echo "üîπ Disk Usage"
        df -h

        echo "üîπ Memory Usage"
        free -h || vm_stat

        echo "üîπ CPU Info"
        lscpu || sysctl -n machdep.cpu.brand_string

        echo "‚úÖ Agent validation successful"
      displayName: "Validate Self-hosted Agent"

# ==============================
# STAGE 2: TOOLCHAIN VALIDATION
# ==============================
- stage: ToolValidation
  displayName: "Stage 2 - Toolchain Validation"
  dependsOn: AgentValidation
  jobs:
  - job: ValidateTools
    steps:
    - script: |
        set -e

        echo "üîπ Checking required tools"

        echo "Git version:"
        git --version

        echo "Docker version:"
        docker --version || echo "Docker not installed"

        echo "Python version:"
        python3 --version || echo "Python not installed"

        echo "Node version:"
        node --version || echo "Node not installed"

        echo "Go version:"
        go version || echo "Go not installed"

        echo "‚úÖ Toolchain validation completed"
      displayName: "Validate Toolchain"

# ==============================
# STAGE 3: CODE QUALITY CHECKS
# ==============================
- stage: CodeQuality
  displayName: "Stage 3 - Code Quality"
  dependsOn: ToolValidation
  jobs:
  - job: LintAndTest
    steps:
    - script: |
        set -e

        echo "üîπ Running code quality checks"

        if [ -f "go.mod" ]; then
          echo "Go project detected"
          go fmt ./...
          go vet ./...
          go test ./...
        fi

        if [ -f "package.json" ]; then
          echo "Node project detected"
          npm install
          npm test || echo "No tests configured"
        fi

        echo "‚úÖ Code quality stage completed"
      displayName: "Lint & Unit Tests"

# ==============================
# STAGE 4: SECURITY CHECKS
# ==============================
- stage: SecurityScan
  displayName: "Stage 4 - Security Scanning"
  dependsOn: CodeQuality
  jobs:
  - job: Security
    steps:
    - script: |
        echo "üîπ Security scan placeholder"

        echo "‚úî Dependency scanning"
        echo "‚úî Secret scanning"
        echo "‚úî SAST hooks"

        echo "NOTE: Integrate tools like:"
        echo "- Trivy"
        echo "- Snyk"
        echo "- SonarQube"

        echo "‚úÖ Security scan stage completed"
      displayName: "Security Scan"

# ==============================
# STAGE 5: BUILD & PACKAGE
# ==============================
- stage: Build
  displayName: "Stage 5 - Build & Package"
  dependsOn: SecurityScan
  jobs:
  - job: BuildApp
    steps:
    - script: |
        set -e

        echo "üîπ Preparing build output directory"
        mkdir -p $(BUILD_OUTPUT)

        echo "üîπ Building application"

        if [ -f "go.mod" ]; then
          go build -o $(BUILD_OUTPUT)/$(APP_NAME)
        fi

        if [ -f "Dockerfile" ]; then
          docker build -t $(APP_NAME):$(Build.BuildId) .
        fi

        echo "‚úÖ Build completed"
      displayName: "Build Application"

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: "$(BUILD_OUTPUT)"
        artifactName: "build-artifacts"
        publishLocation: "Container"
      displayName: "Publish Build Artifacts"

# ==============================
# STAGE 6: DEPLOYMENT READINESS
# ==============================
- stage: DeploymentReady
  displayName: "Stage 6 - Deployment Readiness"
  dependsOn: Build
  jobs:
  - job: DeployCheck
    steps:
    - script: |
        echo "üö¶ Deployment Readiness Check"

        echo "‚úî Artifacts available"
        echo "‚úî Security passed"
        echo "‚úî Tests passed"

        echo "‚úÖ Application ready for deployment to:"
        echo "- DEV"
        echo "- QA"
        echo "- PROD (manual approval)"
      displayName: "Deployment Gate"
